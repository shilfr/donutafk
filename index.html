<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DonutSMP Control Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            donut: { primary: '#FF6B6B', secondary: '#4ECDC4', dark: '#2C3E50' }
          },
          borderRadius: {
            'xl': '1.5rem'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .log-entry { transition: all 0.2s ease; }
    .log-entry:hover { background-color: rgba(255,255,255,0.05); }
    #console { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-donut-dark text-gray-200 min-h-screen">
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-donut-dark to-gray-900">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-96 border border-donut-secondary/20">
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">üç©</div>
        <h1 class="text-2xl font-bold text-donut-secondary">DonutSMP Control Panel</h1>
        <p class="text-gray-400 mt-1">Enter your secret access code</p>
      </div>
      <input type="password" id="secretInput" placeholder="Panel secret..." 
        class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-donut-primary focus:border-transparent mb-4">
      <button onclick="verifyAccess()" 
        class="w-full bg-donut-primary hover:bg-red-500 text-white font-medium py-3 rounded-lg transition-all duration-200 flex items-center justify-center">
        <i class="fas fa-lock mr-2"></i> Unlock Panel
      </button>
      <p id="loginError" class="text-red-400 text-center mt-3 min-h-[24px] text-sm"></p>
    </div>
  </div>

  <!-- Main Panel (hidden initially) -->  <div id="panel" class="hidden">
    <!-- Header -->
    <header class="bg-donut-dark border-b border-donut-secondary/20 py-4 px-6 sticky top-0 z-10">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-donut-secondary flex items-center">
            <i class="fas fa-robot mr-2"></i> DonutSMP Tracker
          </h1>
          <div class="mt-1 flex space-x-4 text-sm">
            <span class="flex items-center"><i class="fas fa-server mr-1 text-donut-primary"></i> <span id="serverDisplay">donutsmp.net:25565</span></span>
            <span class="flex items-center"><i class="fas fa-user mr-1 text-donut-secondary"></i> <span id="userDisplay">Offline</span></span>
            <span class="flex items-center"><i class="fas fa-heartbeat mr-1 text-green-400"></i> <span id="statusBadge" class="font-medium">OFFLINE</span></span>
          </div>
        </div>
        <button onclick="logout()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg flex items-center transition">
          <i class="fas fa-sign-out-alt mr-2"></i> Logout
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Stats Card -->
        <div class="lg:col-span-1 bg-gray-800 rounded-2xl border border-donut-secondary/20 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center text-donut-secondary">
            <i class="fas fa-chart-line mr-2"></i> Live Stats
          </h2>
          <div class="space-y-4">
            <div class="bg-gray-700/50 rounded-xl p-4">
              <div class="text-gray-400 text-sm mb-1">Money</div>
              <div class="text-2xl font-bold text-yellow-300" id="moneyStat">--</div>
            </div>
            <div class="bg-gray-700/50 rounded-xl p-4">
              <div class="text-gray-400 text-sm mb-1">Shards</div>
              <div class="text-2xl font-bold text-purple-300" id="shardsStat">--</div>
            </div>
            <div class="bg-gray-700/50 rounded-xl p-4">
              <div class="text-gray-400 text-sm mb-1">Playtime</div>
              <div class="text-2xl font-bold text-donut-primary" id="playtimeStat">--</div>
            </div>
            <div class="mt-2 pt-3 border-t border-gray-700 text-center text-sm text-gray-400">
              Last updated: <span id="lastUpdate">--</span>
            </div>
          </div>
        </div>

        <!-- Console & Chat -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Console -->          <div class="bg-gray-800 rounded-2xl border border-donut-secondary/20 overflow-hidden">
            <div class="bg-gray-900 px-5 py-3 border-b border-donut-secondary/20 flex justify-between items-center">
              <h2 class="font-bold flex items-center"><i class="fas fa-terminal mr-2 text-green-400"></i> Live Console</h2>
              <button onclick="clearConsole()" class="text-gray-400 hover:text-white text-sm flex items-center">
                <i class="fas fa-trash-alt mr-1"></i> Clear
              </button>
            </div>
            <div id="console" class="h-96 overflow-y-auto p-4 font-mono text-sm space-y-2">
              <div class="text-gray-500">Waiting for bot events...</div>
            </div>
          </div>

          <!-- Chat Input -->
          <div class="bg-gray-800 rounded-2xl border border-donut-secondary/20 p-4">
            <div class="flex space-x-3">
              <input type="text" id="chatInput" placeholder="Type command or message... (e.g., /spawn)" 
                class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-donut-primary focus:border-transparent"
                onkeypress="if(event.key==='Enter') sendChat()">
              <button onclick="sendChat()" 
                class="bg-donut-secondary hover:bg-cyan-400 text-donut-dark font-medium px-6 rounded-lg transition flex items-center">
                <i class="fas fa-paper-plane mr-1"></i> Send
              </button>
            </div>
            <p class="text-xs text-gray-400 mt-2 ml-1">
              <i class="fas fa-info-circle mr-1"></i> Commands sent directly to game. Whisper "<span class="text-donut-primary">cmd /yourcommand</span>" to bot for remote execution.
            </p>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-donut-secondary/20 py-4 text-center text-gray-500 text-sm mt-8">
      <p>DonutSMP Tracker v2.0 ‚Ä¢ Uptime: <span id="uptimeDisplay">--</span> ‚Ä¢ Verified connection with movement monitoring</p>
    </footer>
  </div>

  <script>
    // State
    let panelSecret = '';
    let eventSource = null;
    const LOG_TYPES = {
      success: 'text-green-400',
      error: 'text-red-400',
      chat: 'text-cyan-300',
      command: 'text-yellow-300',
      info: 'text-blue-300',
      disconnect: 'text-red-300'
    };
    // Auth
    async function verifyAccess() {
      const secret = document.getElementById('secretInput').value.trim();
      if (!secret) return showError('Please enter secret');
      
      try {
        const res = await fetch('/api/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ secret })
        });
        const data = await res.json();
        
        if (data.valid) {
          panelSecret = secret;
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('panel').classList.remove('hidden');
          connectEventStream();
          document.getElementById('secretInput').value = '';
        } else {
          showError('Invalid secret code');
        }
      } catch (e) {
        showError('Connection error. Is the bot running?');
      }
    }

    function logout() {
      panelSecret = '';
      if (eventSource) eventSource.close();
      document.getElementById('panel').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('console').innerHTML = '<div class="text-gray-500">Console cleared. Re-login to see events.</div>';
    }

    function showError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      setTimeout(() => el.textContent = '', 3000);
    }

    // Event Stream
    function connectEventStream() {
      eventSource = new EventSource(`/events?secret=${encodeURIComponent(panelSecret)}`, { withCredentials: false });
      
      eventSource.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          handleEvent(data);
        } catch (err) {          console.error('Parse error:', err);
        }
      };
      
      eventSource.onerror = () => {
        setTimeout(connectEventStream, 5000);
      };
    }

    function handleEvent(event) {
      switch(event.type) {
        case 'init':
        case 'state':
          updateState(event.data || event.state);
          break;
        case 'stats':
          updateStats(event.data);
          break;
        case 'log':
          addLog(event.data);
          break;
      }
    }

    // UI Updates
    function updateState(state) {
      document.getElementById('userDisplay').textContent = state.username || 'Offline';
      document.getElementById('statusBadge').textContent = state.isAlive ? 'ONLINE' : 'OFFLINE';
      document.getElementById('statusBadge').className = state.isAlive 
        ? 'font-medium text-green-400' 
        : 'font-medium text-red-400';
      document.getElementById('uptimeDisplay').textContent = state.uptime || '0m';
    }

    function updateStats(stats) {
      document.getElementById('moneyStat').textContent = stats.money || '--';
      document.getElementById('shardsStat').textContent = stats.shards || '--';
      document.getElementById('playtimeStat').textContent = stats.playtime || '--';
      document.getElementById('lastUpdate').textContent = stats.fetchedAt || 'Just now';
    }

    function addLog(entry) {
      const consoleEl = document.getElementById('console');
      const logEl = document.createElement('div');
      logEl.className = `log-entry p-2 rounded border-l-4 ${LOG_TYPES[entry.type] || 'text-gray-300'} border-${LOG_TYPES[entry.type]?.split('-')[1] || 'gray'}-500/50 bg-gray-900/30`;
      logEl.innerHTML = `<span class="text-xs text-gray-500 mr-2">[${entry.time}]</span> ${escapeHtml(entry.message)}`;
      consoleEl.prepend(logEl);
      if (consoleEl.children.length > 200) consoleEl.removeChild(consoleEl.lastChild);
      consoleEl.scrollTop = 0;
    }
    function clearConsole() {
      document.getElementById('console').innerHTML = '<div class="text-gray-500">Console cleared</div>';
    }

    // Chat
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg || !panelSecret) return;
      
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ secret: panelSecret, message: msg })
        });
        
        if (res.ok) {
          addLog({ time: new Date().toLocaleTimeString(), type: 'command', message: `‚Üí Sent: ${msg}` });
          input.value = '';
        } else {
          const err = await res.json();
          addLog({ time: new Date().toLocaleTimeString(), type: 'error', message: `Chat failed: ${err.error}` });
        }
      } catch (e) {
        addLog({ time: new Date().toLocaleTimeString(), type: 'error', message: `Network error: ${e.message}` });
      }
    }

    // Helpers
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, """)
        .replace(/'/g, "&#039;");
    }

    // Auto-focus login
    document.getElementById('secretInput').focus();
    document.getElementById('secretInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') verifyAccess();
    });
  </script>
</body>
        </html>
